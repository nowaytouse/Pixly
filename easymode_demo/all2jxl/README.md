# `all2jxl` - 高性能、无损的JPEG XL转换器

`all2jxl` 是一款专为图像收藏家和效率追求者设计的命令行工具，旨在将您的图片库（JPEG, PNG, GIF等）以最高质量、最安全可靠的方式无损转换为下一代图像格式JPEG XL (.jxl)。

---

## 核心功能

- **全自动智能处理:** 无需任何复杂配置，工具以唯一的"全自动模式"运行，智能识别每一种文件并采用最优策略处理。
- **真正的无损转换:** 保证像素级别的数学无损，确保您的图片在转换过程中不丢失任何质量。
- **全面的验证机制:** 采用多层验证，确保转换后的文件是原始文件的完美再现。
- **完整的元数据保留:** 尽最大努力保留原始文件的所有元数据，包括修改日期和EXIF信息。
- **高性能并发处理:** 充分利用现代CPU的多核性能，并发处理多个文件，大幅缩短等待时间。
- **安全可靠:** 采用事务性操作，避免意外中断导致文件损坏，并能明确跳过不支持的文件类型和损坏的媒体。

---

## "全自动模式"深度解析

`all2jxl` 的核心是其强大而透明的"全自动模式"。当您指定一个目录后，程序会对目录下的每一个文件执行以下精密的操作流程：

### 第1步：文件类型识别
- **忽略扩展名:** 程序不信任文件的扩展名（如`.jpg`或`.png`），而是直接读取每个文件头部的"魔法字节"（Magic Bytes）。
- **精准分类:** 通过分析头部信息，程序可以精确识别文件的真实格式（JPEG, PNG, GIF, 视频, 或其他文件），从根本上避免了因错误扩展名导致的后续处理错误。

### 第2步：智能策略选择
根据识别出的真实文件类型，程序会自动选择最佳的转换策略：

- **对于 JPEG (.jpg, .jpeg, .jfif, .jpe) 文件:**
  - **执行"无损重编码" (Lossless Re-encoding):** 这是本工具的核心优势之一。程序会调用`cjxl`的`--lossless_jpeg=1`参数，这是一个特殊的"转码"操作。它不会将JPEG解码成像素再重新编码，而是直接对JPEG的DCT系数进行无损的重新压缩。**这个过程在数学上是完全可逆的**，意味着您可以从生成的.jxl文件完美地恢复出与原始文件一模一样的JPEG文件，同时享受JXL带来的约20%的体积减小。

- **对于 PNG, GIF, APNG, BMP, TIFF, ICO, CUR 文件:**
  - **执行"数学无损转换" (Mathematically Lossless Conversion):** 程序会使用`cjxl`的`-d 0 -e 9`（距离为0，努力级别9）参数进行转换。这会解码原始图像的每一个像素，然后以保证100%像素值不变的方式，将其重新编码为JPEG XL。这确保了图像质量的绝对无损，通常能带来巨大的体积缩减（特别是对于PNG文件）。
  
- **对于 WebP, AVIF, HEIF 文件:**
  - **执行"数学无损转换" (Mathematically Lossless Conversion):** 程序会使用`cjxl`的`-d 0 -e 9`参数进行转换。对于动画格式，还会使用`--container=1`和`--compress_boxes=1`参数来保留动画信息。

### 第3步：多层交叉验证
这是保证转换质量最关键的一环。对于每一个生成的新JXL文件，程序都会执行严格的验证：

- **像素完美验证 (所有图片):** 程序会将新生成的JXL文件解码回临时图片，然后与原始图片进行**逐像素**的色彩值比对，确保两个文件的图像内容完全一致。
- **动画完整性验证 (针对GIF/WebP/AVIF/HEIF):** 除了像素验证，程序还会：
  1.  读取原始动画文件的总帧数。
  2.  读取新JXL文件的总帧数。
  3.  **比对两者帧数是否完全相等**，确保动画的每一帧都被完整地转换了。

### 第4步：元数据和时间戳迁移
- **EXIF/XMP元数据:** 在验证通过后，程序会调用外部依赖`exiftool`，执行多层级元数据迁移策略：
  1. 尝试完整元数据迁移：`exiftool -TagsFromFile <原文件> -all:all <新文件>`
  2. 关键元数据迁移：迁移关键字段如时间戳、方向、GPS等
  3. 基础时间戳迁移：迁移基本的时间戳信息
  4. 文件系统时间戳：作为最后保障，保留文件系统时间戳
- **文件日期:** 程序会读取原始文件的"最后修改日期"，并将其应用到新的JXL文件上，确保文件在时间线上保持原有的顺序。在macOS上还会同步Finder可见的创建/修改日期。

### 第5步：安全的原地替换
只有当**以上所有步骤都成功完成**后，程序才会执行最后的操作：
1.  删除原始文件（如 `image.png`）。
2.  将临时文件（如 `image.jxl.tmp`）重命名为最终文件（`image.jxl`）。

这个过程确保了即使程序在中途被意外中断，您的原始文件也安然无恙，不会出现文件损坏或数据丢失的情况。

---

## 依赖项

本工具的强大功能依赖于以下三个业界顶尖的命令行工具。请确保它们已被正确安装，并能在您的系统路径中被访问到：

1.  **`cjxl`**: JPEG XL 编码器。
2.  **`djxl`**: JPEG XL 解码器。
3.  **`exiftool`**: 用于读写和处理元数据的工具。

---

## 使用方法

将`all2jxl`可执行文件放置在您的工作目录中，然后通过以下命令运行：

```bash
# 基本用法：处理位于 /path/to/your/images 的文件夹
./all2jxl -dir "/path/to/your/images"

# 高级用法示例：
# 使用指定线程数处理
./all2jxl -dir "/path/to/your/images" -workers 8

# 启用重试机制（最多3次）
./all2jxl -dir "/path/to/your/images" -retries 3

# 启用快速验证模式
./all2jxl -dir "/path/to/your/images" -verify fast

# 试运行模式（仅记录操作不转换）
./all2jxl -dir "/path/to/your/images" -dry-run

# 复制目录到 *_work 后处理
./all2jxl -dir "/path/to/your/images" -copy

# 采样模式（仅处理10个中等大小文件）
./all2jxl -dir "/path/to/your/images" -sample 10

# 跳过已存在的 .jxl 文件
./all2jxl -dir "/path/to/your/images" -skip-exist

# 每个转换任务使用2个线程
./all2jxl -dir "/path/to/your/images" -cjxl-threads 2

# 设置单任务超时为300秒
./all2jxl -dir "/path/to/your/images" -timeout 300
```

**注意:** 如果您的目录路径中包含空格，请务必使用引号将其括起来。

---

## 命令行参数

程序支持以下命令行参数：

- `-dir STRING`: 输入目录路径
- `-workers INT`: 工作线程数 (0=自动检测)
- `-verify STRING`: 验证模式: strict|fast
- `-copy`: 复制目录到 *_work 后处理
- `-sample INT`: 测试模式: 仅处理N个中等大小文件
- `-skip-exist`: 跳过已存在的 .jxl 文件 (默认:true)
- `-dry-run`: 试运行模式: 仅记录操作不转换
- `-cjxl-threads INT`: 每个转换任务的线程数 (默认:1)
- `-timeout INT`: 单任务超时秒数 (0=无限制)
- `-retries INT`: 失败重试次数 (默认:0)

---

## 日志解读

程序会输出详细的日志，帮助您了解每一个文件的处理情况：

- `🔄 开始处理:` 表示开始处理文件
- `✅ 识别为图像格式:` 表示文件被识别为支持的图像格式
- `🎬 检测到动画图像:` 表示检测到动画图像
- `🖼️  静态图像:` 表示检测到静态图像
- `✅ 转换完成:` 表示文件已成功转换为临时.jxl文件
- `🔍 开始验证转换结果:` 表示开始验证转换结果
- `✅ 验证通过:` 表示文件的像素内容和/或帧数已通过验证
- `📋 开始复制元数据:` 表示开始复制元数据
- `✅ 元数据复制成功:` 表示EXIF等元数据已成功复制
- `⚠️  元数据复制失败:` 表示发生了非致命错误（例如元数据复制失败），但文件本身已成功转换并被保留
- `🎉 处理成功:` 表示文件已完成所有步骤，被成功转换为.jxl并替换了原始文件。日志中会包含文件体积的变化
- `❌ 验证失败:` 表示验证失败，转换失败，临时文件已被删除，原始文件保持不变
- `⏭️  跳过已存在:` 表示跳过已存在的 .jxl 文件
- `🎬 跳过视频文件:` 表示跳过视频文件
- `📄 跳过非图像文件:` 表示跳过非图像文件
- `❌ 无法打开文件:` 表示无法打开文件
- `⚠️  动画检测失败:` 表示动画检测失败
- `🔄 重试转换:` 表示重试转换
- `CRITICAL:` 表示发生了非常严重的错误（例如删除了原始文件后重命名失败），需要您手动干预